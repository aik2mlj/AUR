name: Check and Update AUR Packages

on:
  # Run daily at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no commits or pushes)'
        required: false
        default: false
        type: boolean
      package:
        description: 'Specific package to update (leave empty for all)'
        required: false
        default: ''
        type: string

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.check.outputs.matrix }}
      has_updates: ${{ steps.check.outputs.has_updates }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install nvchecker
        run: pip install nvchecker httpx[http2]

      - name: Check for updates
        id: check
        run: |
          # Run nvchecker
          nvchecker -c nvchecker.toml

          # Get updates
          UPDATES=$(nvcmp -c nvchecker.toml 2>/dev/null || true)

          if [[ -z "$UPDATES" ]]; then
            echo "No updates found"
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Updates found:"
          echo "$UPDATES"
          echo "has_updates=true" >> $GITHUB_OUTPUT

          # Build matrix JSON
          MATRIX='{"include":['
          FIRST=true

          while IFS= read -r line; do
            [[ -z "$line" ]] && continue

            PKG=$(echo "$line" | awk '{print $1}')
            OLD_VER=$(echo "$line" | awk '{print $2}')
            NEW_VER=$(echo "$line" | awk '{print $NF}')

            # Filter by specific package if requested
            if [[ -n "${{ github.event.inputs.package }}" && "$PKG" != "${{ github.event.inputs.package }}" ]]; then
              continue
            fi

            if [[ "$FIRST" != "true" ]]; then
              MATRIX="$MATRIX,"
            fi
            MATRIX="$MATRIX{\"package\":\"$PKG\",\"old_version\":\"$OLD_VER\",\"new_version\":\"$NEW_VER\"}"
            FIRST=false
          done <<< "$UPDATES"

          MATRIX="$MATRIX]}"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

      - name: Save new versions
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: version-files
          path: new_ver.json

  update-package:
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true' && github.event.inputs.dry_run != true
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.check-updates.outputs.matrix) }}

    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git openssh jq curl pacman-contrib

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config --global user.name "${{ secrets.AUR_USERNAME }}"
          git config --global user.email "${{ secrets.AUR_EMAIL }}"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Update PKGBUILD
        id: update
        working-directory: ${{ matrix.package }}
        run: |
          echo "Updating ${{ matrix.package }} from ${{ matrix.old_version }} to ${{ matrix.new_version }}"

          # Special handling for sparta-plugins-bin
          if [[ "${{ matrix.package }}" == "sparta-plugins-bin" ]]; then
            RELEASE_INFO=$(curl -s "https://api.github.com/repos/leomccormack/SPARTA/releases/latest")
            ASSET_NAME=$(echo "$RELEASE_INFO" | jq -r '.assets[].name' | grep -E '^Linux_SPARTA_VST3_' | head -1)
            if [[ -n "$ASSET_NAME" ]]; then
              LONG_VERSION=$(echo "$ASSET_NAME" | sed -E 's/Linux_SPARTA_VST3_(.*)\.zip/\1/')
              echo "Detected long version: $LONG_VERSION"
              sed -i "s/^_long_pkgver=.*/_long_pkgver=$LONG_VERSION/" PKGBUILD
            fi
          else
            sed -i "s/^pkgver=.*/pkgver=${{ matrix.new_version }}/" PKGBUILD
          fi

          # Reset pkgrel
          sed -i 's/^pkgrel=.*/pkgrel=1/' PKGBUILD

          # Update checksums
          echo "Updating checksums..."
          updpkgsums

          # Generate .SRCINFO
          echo "Regenerating .SRCINFO..."
          makepkg --printsrcinfo > .SRCINFO

          echo "PKGBUILD updated successfully"

      - name: Set up SSH for AUR
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          ssh-keyscan -t ed25519,rsa aur.archlinux.org >> ~/.ssh/known_hosts 2>/dev/null
          cat >> ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
          EOF

      - name: Push to AUR
        working-directory: ${{ matrix.package }}
        run: |
          PKG="${{ matrix.package }}"
          VER="${{ matrix.new_version }}"

          echo "Pushing $PKG to AUR..."

          # Clone the AUR repo
          cd /tmp
          git clone "ssh://aur@aur.archlinux.org/${PKG}.git" aur-repo || {
            # If clone fails, init new repo
            mkdir aur-repo
            cd aur-repo
            git init
            git remote add origin "ssh://aur@aur.archlinux.org/${PKG}.git"
            cd /tmp
          }

          cd aur-repo

          # Copy updated files
          cp "$GITHUB_WORKSPACE/$PKG/PKGBUILD" .
          cp "$GITHUB_WORKSPACE/$PKG/.SRCINFO" .

          # Copy any additional files
          for f in *.install *.patch *.desktop *.png *.service; do
            [[ -f "$GITHUB_WORKSPACE/$PKG/$f" ]] && cp "$GITHUB_WORKSPACE/$PKG/$f" .
          done 2>/dev/null || true

          # Commit and push
          git add -A
          git commit -m "Update to $VER"
          git push origin master

          echo "Successfully pushed $PKG to AUR"

      - name: Upload updated PKGBUILD
        uses: actions/upload-artifact@v4
        with:
          name: pkgbuild-${{ matrix.package }}
          path: |
            ${{ matrix.package }}/PKGBUILD
            ${{ matrix.package }}/.SRCINFO

  commit-to-github:
    needs: [check-updates, update-package]
    if: needs.check-updates.outputs.has_updates == 'true' && github.event.inputs.dry_run != true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download version file
        uses: actions/download-artifact@v4
        with:
          name: version-files
          path: .

      - name: Download all PKGBUILDs
        uses: actions/download-artifact@v4
        with:
          pattern: pkgbuild-*
          merge-multiple: true

      - name: Update old_ver.json
        run: cp new_ver.json old_ver.json

      - name: Commit and push to GitHub
        run: |
          git config user.name "${{ secrets.AUR_USERNAME }}"
          git config user.email "${{ secrets.AUR_EMAIL }}"

          git add -A
          git diff --staged --quiet && exit 0

          # Build commit message from matrix
          MATRIX='${{ needs.check-updates.outputs.matrix }}'
          MSG="chore: update AUR packages"

          echo "$MATRIX" | jq -r '.include[] | "- \(.package): \(.old_version) -> \(.new_version)"' | while read line; do
            MSG="$MSG
          $line"
          done

          git commit -m "$MSG"
          git push
